import os
import gradio as gr
from jade.core import JadeAgent
from pathlib import Path

# --- Configura√ß√£o ---
# IMPORTANTE: Cole sua chave de API da Groq aqui!
os.environ["GROQ_API_KEY"] = "GROQ_KEY"

print("Iniciando a J.A.D.E....")
agent = JadeAgent()
print("J.A.D.E. pronta.")

# --- L√≥gica da Interface Gradio Multimodal ---

def process_multimodal_input(text_input, audio_file):
    # Esta fun√ß√£o centraliza o processamento de entrada
    user_input = ""
    contexto_adicional = ""

    if audio_file:
        print(f"Processando arquivo de √°udio: {audio_file}")
        path = Path(audio_file)
        try:
            with open(path, "rb") as f:
                transcription = agent.client.audio.transcriptions.create(
                    file=(path.name, f.read()), model=agent.cfg["audio_model"]
                )
            texto_transcrito = (transcription.text or "").strip()
            print(f"üó£Ô∏è Texto transcrito: {texto_transcrito}")
            contexto_adicional = f" (O usu√°rio tamb√©m enviou um √°udio que diz: '{texto_transcrito}')"
        except Exception as e:
            print(f"Erro ao processar √°udio: {e}")
            contexto_adicional = " (Houve um erro ao processar o √°udio enviado.)"

    # Combina a entrada de texto com o contexto do √°udio
    if text_input:
        user_input = text_input + contexto_adicional
    elif contexto_adicional:
        # Se n√£o houver texto, a transcri√ß√£o se torna a entrada principal
        user_input = texto_transcrito
    else:
        return "Por favor, envie uma mensagem de texto ou um arquivo de √°udio.", ""

    # Obter a resposta do agente e tocar o √°udio TTS
    response = agent.respond(user_input)
    # A fun√ß√£o agent.respond j√° exibe o player de √°udio no Colab
    
    # A mensagem que o usu√°rio ver√° no chat
    display_message = user_input if len(user_input) < 200 else text_input + " [√Åudio Processado]"
    
    return response, display_message

# --- Cria√ß√£o da Interface com Gradio Blocks e Chatbot ---

with gr.Blocks(theme=gr.themes.Soft()) as demo:
    gr.Markdown("# J.A.D.E. - Interface Multimodal")
    
    # Componente para exibir o hist√≥rico do chat
    chatbot = gr.Chatbot(label="Chat", height=500)
    
    with gr.Row():
        text_input = gr.Textbox(
            label="Mensagem",
            placeholder="Digite sua mensagem aqui...",
            scale=4, # Faz a caixa de texto maior
        )
        audio_input = gr.Audio(
            label="Enviar √Åudio",
            sources=["upload"],
            type="filepath",
            scale=1,
        )

    submit_btn = gr.Button("Enviar", variant="primary")

    # Fun√ß√£o principal que atualiza o chat
    def respond_interface(user_text, user_audio, chat_history):
        # 1. Processa as entradas (texto e/ou √°udio)
        bot_message, display_user_message = process_multimodal_input(user_text, user_audio)
        
        # 2. Adiciona a mensagem do usu√°rio e a resposta do bot ao hist√≥rico
        new_chat_history = chat_history + [[display_user_message, bot_message]]
        
        # 3. Retorna o hist√≥rico atualizado para o componente chatbot
        return new_chat_history, "", None # Limpa a caixa de texto e o √°udio

    # Conecta o bot√£o "Enviar" √† fun√ß√£o
    submit_btn.click(
        fn=respond_interface,
        inputs=[text_input, audio_input, chatbot],
        outputs=[chatbot, text_input, audio_input] # Sa√≠das para atualizar
    )
    
    # Permite enviar com "Enter" na caixa de texto
    text_input.submit(
        fn=respond_interface,
        inputs=[text_input, audio_input, chatbot],
        outputs=[chatbot, text_input, audio_input]
    )

print("Lan√ßando interface web de chat multimodal com Gradio...")
demo.launch(debug=True)
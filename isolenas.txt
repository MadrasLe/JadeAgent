# @title üéß J.A.D.E. Scholar - Vers√£o Interc√¢mbio (Vozes Distintas)

import os
import re
import json
import textwrap
from io import BytesIO

# --- Setup Garantido ---
try:
    import pypdf
    import gtts
    import pydub
    import groq
except ImportError:
    os.system('pip install -q groq pypdf gtts pydub')

# Importa√ß√µes Globais
from pypdf import PdfReader
from gtts import gTTS
from pydub import AudioSegment
from groq import Groq

if not os.path.exists("/usr/bin/ffmpeg"):
    os.system('apt-get install -q ffmpeg')

from IPython.display import Audio, display

# Chave API
os.environ["GROQ_API_KEY"] = "GROQ_API_KEY" 

# --- Classes (Resumidas para focar na mudan√ßa do √°udio) ---

class PDFIngestor:
    def extract(self, filepath):
        print(f"üìÑ [Leitor] Lendo {filepath}...")
        try:
            reader = PdfReader(filepath)
            text = "".join([p.extract_text() or "" for p in reader.pages])
            return re.sub(r'\s+', ' ', text).strip()
        except Exception as e:
            print(e)
            return None

class ContentBrain:
    def __init__(self):
        self.client = Groq()
        self.model = "llama-3.3-70b-versatile"

    def summarize(self, text):
        print("üß† [C√©rebro] Resumindo...")
        prompt = f"Resuma didaticamente em PT-BR este texto:\n{text[:15000]}"
        chat = self.client.chat.completions.create(messages=[{"role":"user", "content":prompt}], model=self.model)
        return chat.choices[0].message.content

    def script_podcast(self, summary):
        print("‚úçÔ∏è [Roteirista] Criando roteiro...")
        prompt = f"""
        Crie um roteiro de podcast curto (6 falas).
        Personagens:
        - GABRIEL (Brasileiro, curioso).
        - BERTA (Professora, explica bem).
        
        SA√çDA: JSON Puro. Lista de objetos: [{{"speaker": "Gabriel", "text": "..."}}, ...]
        Resumo: {summary}
        """
        chat = self.client.chat.completions.create(messages=[{"role":"user", "content":prompt}], model=self.model)
        try:
            return json.loads(chat.choices[0].message.content.replace("```json","").replace("```",""))
        except:
            return [{"speaker": "Gabriel", "text": "Ol√° Berta!"}, {"speaker": "Berta", "text": "Ol√° Gabriel!"}]

# --- A MUDAN√áA M√ÅGICA EST√Å AQUI üëá ---

class AudioProducer:
    def generate_show(self, script, filename="podcast_intercambio.mp3"):
        print("üéôÔ∏è [Est√∫dio] Gravando com sotaques diferentes...")
        final_mix = AudioSegment.silent(duration=500)
        
        for i, line in enumerate(script):
            speaker = line['speaker'].upper()
            text = line['text']
            print(f"   üó£Ô∏è Gravando: {speaker}...", end=" ")
            
            mp3_fp = BytesIO()
            
            if "BERTA" in speaker:
                # BERTA = SOTAQUE DE PORTUGAL (tld='pt')
                # Isso muda a voz para a "Maria" (voz padr√£o PT-PT do Google)
                tts = gTTS(text=text, lang='pt', tld='pt', slow=False)
                print("(Modo: üáµüáπ Portugal)")
            else:
                # GABRIEL = SOTAQUE DO BRASIL (tld='com.br')
                tts = gTTS(text=text, lang='pt', tld='com.br', slow=False)
                print("(Modo: üáßüá∑ Brasil)")
            
            tts.write_to_fp(mp3_fp)
            mp3_fp.seek(0)
            segment = AudioSegment.from_file(mp3_fp, format="mp3")
            
            final_mix += segment
            final_mix += AudioSegment.silent(duration=350)
            
        final_mix.export(filename, format="mp3")
        return filename

# --- Execu√ß√£o ---

def run():
    pdf = "artigo_ia.pdf"
    # Cria PDF se n√£o existir
    if not os.path.exists(pdf):
        from fpdf import FPDF
        d = FPDF(); d.add_page(); d.set_font("Arial", size=12)
        d.multi_cell(0,10,"Agentes de IA aut√¥nomos revolucionar√£o o trabalho com orquestra√ß√£o de grafos.")
        d.output(pdf)
        
    brain = ContentBrain()
    ingest = PDFIngestor()
    studio = AudioProducer()
    
    text = ingest.extract(pdf)
    summ = brain.summarize(text)
    script = brain.script_podcast(summ)
    
    # Gera o √°udio com a nova t√©cnica
    f = studio.generate_show(script)
    
    print("\nüéß AGORA SIM! Note a diferen√ßa de sotaque:")
    display(Audio(f, autoplay=True))

if __name__ == "__main__":
    run()